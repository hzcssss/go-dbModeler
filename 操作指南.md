# GoDBModeler 操作指南

## 功能概述

GoDBModeler 是一个简化版的数据库建模工具，支持从多种数据库生成 TypeScript 模型代码，包含以下核心功能：

- **连接管理**：支持 MySQL、PostgreSQL、SQLite 数据库连接配置
- **TS模型生成**：使用默认模板和自定义脚本生成 TypeScript 代码

## 快速开始

### 1. 数据库连接管理
#### 添加连接
1. 打开应用，进入"连接管理"标签页
2. 点击"添加连接"按钮
3. 填写数据库连接信息（类型、主机、端口、用户名、密码、数据库名）
4. 点击"保存连接"

#### 删除连接
1. 在"连接管理"标签页中，找到要删除的连接
2. 点击连接右侧的"删除"按钮
3. 在弹出的确认对话框中点击"确认"完成删除

### 2. 生成 TypeScript 代码
1. 切换到"TS模型生成"标签页
2. 选择数据库连接 → 选择数据库 → 选择表
3. 可选：在脚本编辑器中编写自定义脚本
4. 点击"生成TS模型"按钮
5. 使用"复制到剪贴板"或"保存为文件"按钮导出代码

### 3. 脚本管理
脚本管理功能允许您创建、编辑、删除和重用自定义脚本，提供更灵活的代码生成控制。

#### 添加新脚本
1. 切换到"脚本管理"标签页
2. 点击"添加脚本"按钮
3. 填写脚本信息：
   - **脚本名称**：便于识别的名称
   - **脚本描述**：可选，说明脚本用途
   - **脚本内容**：JavaScript 代码
4. 点击"保存"按钮

#### 编辑脚本
1. 在脚本列表中点击要编辑的脚本
2. 修改脚本内容
3. 点击"保存"按钮

#### 删除脚本
1. 在脚本列表中点击要删除的脚本
2. 点击"删除"按钮
3. 确认删除操作

#### 使用脚本
1. 在"TS模型生成"标签页中，可以从下拉菜单选择已保存的脚本
2. 或者点击"加载脚本"按钮选择脚本文件

### 4. 脚本编写指南
#### 基本结构
```javascript
// 输入对象包含数据库表结构信息
// input: { tableName, columns, primaryKey, indexes, foreignKeys }

// 必须设置 output 变量作为最终输出
output = generateCode(input);

function generateCode(data) {
    // 在这里编写生成代码的逻辑
    let code = '';
    
    // 示例：生成 TypeScript 接口
    code += `export interface ${data.tableName} {\n`;
    
    data.columns.forEach(column => {
        code += `  ${column.name}: ${mapType(column.type)};\n`;
    });
    
    code += '}\n';
    return code;
}

function mapType(dbType) {
    // 数据库类型到 TypeScript 类型的映射
    const typeMap = {
        'int': 'number',
        'varchar': 'string',
        'text': 'string',
        'datetime': 'Date',
        'boolean': 'boolean'
    };
    return typeMap[dbType.toLowerCase()] || 'any';
}
```

#### 可用变量和方法
- `input`: 包含表结构数据的对象
- `console.log()`: 用于调试输出
- `output`: 必须设置的最终输出变量

#### 示例脚本
1. **基础接口生成**：根据表结构生成 TypeScript 接口
2. **带验证的DTO**：生成包含数据验证的 Data Transfer Object
3. **GraphQL类型**：生成 GraphQL schema 类型定义
4. **Prisma模型**：生成 Prisma schema 定义
5. **自定义格式**：支持任何自定义代码格式需求

### 5. 自定义脚本（旧方式）
1. 在"TS模型生成"标签页中编写 JavaScript 脚本
2. 脚本接收 `input` 对象，必须设置 `output` 变量
3. 可以使用"加载脚本文件"按钮导入外部脚本

## 打包指南

### 打包前清理

为确保打包的应用程序不包含任何敏感数据（如数据库连接信息），请先运行清理脚本：

```bash
# 运行打包前清理脚本
./scripts/package_clean.sh
```

> **注意**：数据库连接配置存储在用户主目录下的 `.godbmodeler/config.json` 文件中，不会被包含在打包的应用程序中。每个用户安装应用后会创建自己的配置文件。

### macOS 打包

```bash
# 编译 macOS 版本
GOOS=darwin GOARCH=arm64 go build -o bin/go-DBmodeler ./cmd/app/

# 使用 fyne 工具打包为 .app（确保指定正确的可执行文件）
fyne package --os darwin --executable bin/go-DBmodeler --app-id com.godbmodeler.app --name DBmodeler

# 创建 DMG 安装包
hdiutil create -volname "DBmodeler" -srcfolder DBmodeler.app -ov -format UDZO DBmodeler.dmg
```

> **注意**：如果 fyne 命令不在 PATH 中，需要先安装：`go install fyne.io/tools/cmd/fyne@latest`。
> 如果 Go 不在 PATH 中，需要设置 PATH 环境变量：`PATH=$PATH:/path/to/go/bin`

### Windows 打包

```bash
# 编译 Windows 版本
GOOS=windows GOARCH=amd64 go build -o bin/go-DBmodeler-windows.exe ./cmd/app/

# 使用 fyne 工具打包为 exe
fyne package -os windows -appID com.godbmodeler.app -icon resources/icons/app.svg

# 如果需要图形化安装包，可以使用 Inno Setup 或 NSIS
```

### 跨平台打包脚本

创建 `build.sh` 脚本：

```bash
#!/bin/bash

# macOS
echo "Building for macOS..."
GOOS=darwin GOARCH=arm64 go build -o bin/go-DBmodeler-macos ./cmd/app/

# Windows  
echo "Building for Windows..."
GOOS=windows GOARCH=amd64 go build -o bin/go-DBmodeler-windows.exe ./cmd/app/

# Linux
echo "Building for Linux..."
GOOS=linux GOARCH=amd64 go build -o bin/go-DBmodeler-linux ./cmd/app/

echo "Build completed!"
```

### 使用 Docker 打包

创建 `Dockerfile`：

```dockerfile
FROM golang:1.21 AS builder

WORKDIR /app
COPY . .
RUN go mod download

# 构建多个平台
RUN GOOS=darwin GOARCH=arm64 go build -o bin/go-DBmodeler-macos ./cmd/app/
RUN GOOS=windows GOARCH=amd64 go build -o bin/go-DBmodeler-windows.exe ./cmd/app/
RUN GOOS=linux GOARCH=amd64 go build -o bin/go-DBmodeler-linux ./cmd/app/

FROM scratch AS output
COPY --from=builder /app/bin/ /output/
```

## 开发指南

### 项目结构
```
go-DBmodeler/
├── cmd/app/           # 主应用程序入口
├── internal/          # 内部包
│   ├── app/          # 应用核心
│   ├── config/       # 配置管理
│   ├── db/           # 数据库连接和元数据
│   ├── generator/    # 代码生成器
│   └── ui/           # 用户界面
├── resources/         # 资源文件
└── templates/         # 代码模板
```

## 常见问题

### Q: 中文显示异常怎么办？
A: 应用会自动检测系统字体，也可以手动设置 `FYNE_FONT` 环境变量指向中文字体文件

### Q: 脚本执行出错怎么办？
A: 检查脚本语法，确保设置了 `output` 变量，可以使用 `console.log()` 调试

### Q: 通过隔空投送（AirDrop）接收应用后提示文件损坏怎么办？
A: 这是 macOS 安全机制导致的，可以通过以下方法解决：
   1. 打开"系统偏好设置" → "安全性与隐私" → "通用"
   2. 点击锁图标并输入密码解锁设置
   3. 在"允许从以下位置下载的应用"部分，选择"任何来源"（如果没有此选项，请在终端执行 `sudo spctl --master-disable`）
   4. 或者在终端中执行：`xattr -cr /Applications/DBmodeler.app`（假设应用位于应用程序文件夹）
   5. 然后重新尝试打开应用

## 技术支持

- 查看日志文件：`godbmodeler.log`
- 报告问题：检查日志文件中的错误信息
- 功能建议：通过 GitHub Issues 提交

---
*最后更新: 2025-09-08*