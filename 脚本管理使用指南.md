# GoDBModeler 脚本管理功能使用指南

## 📋 功能概述

脚本管理功能允许您创建、编辑、删除和重用自定义 JavaScript 脚本，用于生成高度定制化的 TypeScript 代码。支持从文件系统导入脚本文件，并提供丰富的示例模板。

## 🚀 快速开始

### 1. 访问脚本管理
1. 启动 GoDBModeler 应用程序
2. 切换到"脚本管理"标签页
3. 您将看到左侧的脚本列表和右侧的预览区域

### 2. 创建新脚本
1. 点击"新增脚本"按钮
2. 输入脚本名称和内容
3. 点击"保存"按钮
4. 脚本将保存到应用程序配置目录

### 3. 导入外部脚本
1. 点击"导入脚本"按钮
2. 选择本地的 `.js` 文件
3. 确认脚本名称和内容
4. 文件将保存到 `~/.godbmodeler/scripts/imported/` 目录

### 4. 使用脚本
1. 在"TS模型生成"标签页中
2. 从脚本下拉菜单中选择已保存的脚本
3. 或者点击"加载脚本"按钮选择脚本文件

## 📁 文件存储位置

### 应用程序管理的脚本
- 位置: `~/.godbmodeler/config.json`
- 特点: 与应用程序配置一起存储
- 管理: 通过应用程序界面管理

### 导入的脚本文件
- 位置: `~/.godbmodeler/scripts/imported/`
- 特点: 独立的 `.js` 文件
- 管理: 可以手动编辑或通过应用程序导入

## 🎯 脚本编写指南

### 输入对象结构
```javascript
// input 对象包含完整的表结构信息
input = {
  tableName: "users",           // 表名
  comment: "用户表",            // 表注释
  fields: [                     // 字段数组
    {
      name: "id",              // 字段名
      type: "int",             // 数据库类型
      tsType: "number",        // TypeScript 类型
      isPrimary: true,         // 是否主键
      isNullable: false,       // 是否可为空
      comment: "用户ID",       // 字段注释
      defaultValue: null       // 默认值
    },
    // ... 更多字段
  ],
  indexes: [...],               // 索引信息
  foreignKeys: [...]           // 外键信息
}
```

### 必须设置的变量
```javascript
// 必须设置 output 变量作为最终输出
output = "生成的TypeScript代码";

// 可以使用 console.log() 进行调试
console.log("开始生成代码...");
```

### 常用工具函数
```javascript
// 数据库类型到 TypeScript 类型映射
function mapType(dbType) {
  const typeMap = {
    'int': 'number',
    'varchar': 'string', 
    'datetime': 'Date',
    'boolean': 'boolean'
  };
  return typeMap[dbType.toLowerCase()] || 'any';
}

// 转换为驼峰命名
function toCamelCase(str) {
  return str.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
}

// 转换为帕斯卡命名
function toPascalCase(str) {
  const camel = toCamelCase(str);
  return camel.charAt(0).toUpperCase() + camel.slice(1);
}
```

## 📝 示例脚本模板

### 1. 基础接口生成
```javascript
// 生成基础的 TypeScript 接口
let output = `export interface ${input.tableName} {\n`;

input.fields.forEach(field => {
  output += `  ${field.name}: ${field.tsType};\n`;
});

output += '}\n';
```

### 2. 带完整注释的接口
```javascript
// 生成带完整注释的接口
let output = `/**\n * ${input.tableName} 实体接口\n */\n`;
output += `export interface ${input.tableName} {\n`;

input.fields.forEach(field => {
  output += `  /**\n   * ${field.comment || field.name}\n`;
  output += `   * 类型: ${field.type}\n`;
  if (field.isPrimary) output += `   * 主键字段\n`;
  if (field.isNullable) output += `   * 允许为空\n`;
  output += `   */\n`;
  output += `  ${field.name}${field.isNullable ? '?' : ''}: ${field.tsType};\n\n`;
});

output += '}\n';
```

### 3. 生成 DTO 类
```javascript
// 生成创建和更新 DTO
let output = '';

// 创建 DTO
output += `export interface Create${input.tableName}Dto {\n`;
input.fields.forEach(field => {
  if (!field.isPrimary) {
    output += `  ${field.name}${field.isNullable ? '?' : ''}: ${field.tsType};\n`;
  }
});
output += '}\n\n';

// 更新 DTO  
output += `export interface Update${input.tableName}Dto {\n`;
input.fields.forEach(field => {
  if (!field.isPrimary) {
    output += `  ${field.name}?: ${field.tsType};\n`;
  }
});
output += '}\n';
```

### 4. 生成 GraphQL 类型
```javascript
// 生成 GraphQL Schema
let output = `# ${input.tableName} GraphQL 类型定义\n`;
output += `type ${input.tableName} {\n`;

input.fields.forEach(field => {
  const gqlType = mapToGraphQLType(field.tsType);
  output += `  ${field.name}: ${gqlType}${field.isNullable ? '' : '!'}\n`;
});

output += '}\n\n';

function mapToGraphQLType(tsType) {
  const map = {
    'number': 'Float',
    'string': 'String', 
    'boolean': 'Boolean',
    'Date': 'String'
  };
  return map[tsType] || 'String';
}
```

### 5. 生成 Prisma Schema
```javascript
// 生成 Prisma 模型定义
let output = `// ${input.tableName} Prisma 模型\n`;
output += `model ${input.tableName} {\n`;

input.fields.forEach(field => {
  const prismaType = mapToPrismaType(field.type);
  output += `  ${field.name} ${prismaType}${field.isPrimary ? ' @id' : ''}${field.isNullable ? '' : ''}\n`;
});

output += '}\n\n';

function mapToPrismaType(dbType) {
  const map = {
    'int': 'Int',
    'varchar': 'String',
    'text': 'String',
    'datetime': 'DateTime',
    'boolean': 'Boolean'
  };
  return map[dbType.toLowerCase()] || 'String';
}
```

## 🔧 高级用法

### 条件生成
```javascript
// 根据条件生成不同的代码
let output = '';

if (input.tableName.includes('Log') || input.tableName.includes('History')) {
  // 日志表特殊处理
  output = generateLogInterface(input);
} else if (input.fields.some(f => f.isPrimary)) {
  // 有主键的表
  output = generateStandardInterface(input);
} else {
  // 其他表
  output = generateBasicInterface(input);
}
```

### 代码格式化
```javascript
// 自动格式化生成的代码
function formatCode(code) {
  // 缩进处理
  code = code.replace(/^  /gm, '  ');
  
  // 空行处理
  code = code.replace(/\n\s*\n/g, '\n\n');
  
  // 结尾换行
  if (!code.endsWith('\n')) {
    code += '\n';
  }
  
  return code;
}

output = formatCode(generateCode(input));
```

### 错误处理
```javascript
try {
  // 主要的生成逻辑
  output = generateMainCode(input);
  
  // 验证输出
  if (!output || typeof output !== 'string') {
    throw new Error('输出必须是非空字符串');
  }
  
} catch (error) {
  console.error('脚本执行错误:', error.message);
  output = `// 脚本执行错误: ${error.message}\n` +
           `// 请检查脚本语法和逻辑\n`;
}
```

## 🚨 常见问题

### Q: 脚本执行没有输出怎么办？
A: 检查是否设置了 `output` 变量，确保脚本最后有 `output = "代码"` 语句

### Q: 如何调试脚本？
A: 使用 `console.log()` 输出调试信息，可以在开发者工具中查看

### Q: 导入的脚本在哪里？
A: 导入的脚本保存在 `~/.godbmodeler/scripts/imported/` 目录

### Q: 支持哪些 JavaScript 特性？
A: 支持标准的 ES6+ 语法，包括箭头函数、模板字符串、解构等

### Q: 如何分享脚本？
A: 导出脚本文件分享给其他用户，他们可以通过导入功能使用

## 📋 最佳实践

1. **命名规范**: 使用有意义的脚本名称，如 `user-entity-with-comments`
2. **注释说明**: 在脚本开头添加使用说明和示例
3. **错误处理**: 添加适当的错误处理逻辑
4. **模块化**: 将复杂逻辑拆分为多个函数
5. **测试验证**: 在保存前测试脚本是否正常工作

## 🆘 技术支持

如果遇到问题：
1. 检查应用程序日志
2. 验证脚本语法是否正确
3. 确保设置了 `output` 变量
4. 使用简单的示例脚本测试

---
*最后更新: 2025-09-09*